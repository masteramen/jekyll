---
layout: post
title:  "XA ÂàÜÂ∏ÉÂºè‰∫ãÂä°„ÄêÊé®ËçêÈòÖËØª„Äë"
title2:  "XA ÂàÜÂ∏ÉÂºè‰∫ãÂä°„ÄêÊé®ËçêÈòÖËØª„Äë"
date:   2017-01-01 23:59:15  +0800
source:  "https://www.jfox.info/xa%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e6%8e%a8%e8%8d%90%e9%98%85%e8%af%bb.html"
fileName:  "20170101455"
lang:  "zh_CN"
published: true
permalink: "2017/xa%e5%88%86%e5%b8%83%e5%bc%8f%e4%ba%8b%e5%8a%a1%e6%8e%a8%e8%8d%90%e9%98%85%e8%af%bb.html"
---
{% raw %}
# XA ÂàÜÂ∏ÉÂºè‰∫ãÂä°„ÄêÊé®ËçêÈòÖËØª„Äë 


1. RocketMQ / MyCAT / Sharding-JDBC **ÊâÄÊúâ**Ê∫êÁ†ÅÂàÜÊûêÊñáÁ´†ÂàóË°®
2. RocketMQ / MyCAT / Sharding-JDBC **‰∏≠ÊñáÊ≥®ÈáäÊ∫êÁ†Å GitHub Âú∞ÂùÄ**
3. ÊÇ®ÂØπ‰∫éÊ∫êÁ†ÅÁöÑÁñëÈóÆÊØèÊù°ÁïôË®Ä**ÈÉΩ**Â∞ÜÂæóÂà∞**ËÆ§Áúü**ÂõûÂ§ç„ÄÇ**ÁîöËá≥‰∏çÁü•ÈÅìÂ¶Ç‰ΩïËØªÊ∫êÁ†Å‰πüÂèØ‰ª•ËØ∑ÊïôÂô¢**„ÄÇ
4. **Êñ∞ÁöÑ**Ê∫êÁ†ÅËß£ÊûêÊñáÁ´†**ÂÆûÊó∂**Êî∂Âà∞ÈÄöÁü•„ÄÇ**ÊØèÂë®Êõ¥Êñ∞‰∏ÄÁØáÂ∑¶Âè≥**„ÄÇ
5. **ËÆ§ÁúüÁöÑ**Ê∫êÁ†Å‰∫§ÊµÅÂæÆ‰ø°Áæ§„ÄÇ

- [1. Ê¶ÇËø∞](1. Ê¶ÇËø∞)
- [2. ‰∏ªÊµÅÁ®ã](2. ‰∏ªÊµÅÁ®ã)
- [3. Êü•ËØ¢Êìç‰Ωú](3. Êü•ËØ¢Êìç‰Ωú)
- [4. ÊèíÂÖ•Êìç‰Ωú](4. ÊèíÂÖ•Êìç‰Ωú)
- [5. ÂΩ©Ëõã](5. ÂΩ©Ëõã)

# 1. Ê¶ÇËø∞

ÂèØËÉΩ‰Ω†Âú®ÁúãÂà∞Ëøô‰∏™Ê†áÈ¢ò‰ºöÂ∞èÂ∞èÁöÑÂêÉÊÉäÔºåMyCAT ËÉΩ‰ΩøÁî® MongoDB ÂÅöÊï∞ÊçÆËäÇÁÇπ„ÄÇÊòØÁöÑÔºåÊ≤°ÈîôÔºåÁ°ÆÂÆûÂèØ‰ª•„ÄÇ 
ÂêºÂêºÂêºÔºåËÆ©Êàë‰ª¨ÂºÄÂêØËøôÊÆµÁ•ûÂ•áÁöÑ‚ÄúÊóÖÈÄî‚Äù„ÄÇ

Êú¨Êñá‰∏ªË¶ÅÂàÜÊàêÂõõÈÉ®ÂàÜÔºö

1. ÊÄª‰ΩìÊµÅÁ®ãÔºåËÆ©‰Ω†Êúâ‰∏™Êï¥‰ΩìÁöÑËÆ§ËØÜ
2. Êü•ËØ¢Êìç‰Ωú
3. ÊèíÂÖ•Êìç‰Ωú
4. ÂΩ©ËõãÔºåüòàÂΩ©ËõãÔºåüôÇÂΩ©Ëõã

Âª∫ËÆÆ‰Ω†ÁúãËøáËøô‰∏§ÁØáÊñáÁ´†Ôºà_ÈùûÂøÖÈ°ª_ÔºâÔºö

1. [„ÄäMyCAT Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî „ÄêÂçïÂ∫ìÂçïË°®„ÄëÊèíÂÖ•„Äã](https://www.jfox.info/go.php?url=http://www.yunai.me/MyCAT/single-db-single-table-insert/?self)
2. [„ÄäMyCAT Ê∫êÁ†ÅÂàÜÊûê ‚Äî‚Äî „ÄêÂçïÂ∫ìÂçïË°®„ÄëÊü•ËØ¢„Äã](https://www.jfox.info/go.php?url=http://www.yunai.me/MyCAT/single-db-single-table-select/?self)

# 2. ‰∏ªÊµÅÁ®ã

![](4c6864f.png)

1. `MyCAT Server` Êé•Êî∂ `MySQL Client` Âü∫‰∫é **MySQLÂçèËÆÆ** ÁöÑËØ∑Ê±ÇÔºåÁøªËØë **SQL** Êàê **MongoDBÊìç‰Ωú** ÂèëÈÄÅÁªô `MongoDB Server`„ÄÇ
2. `MyCAT Server` Êé•Êî∂ `MongoDB Server` ËøîÂõûÁöÑ **MongoDBÊï∞ÊçÆ**ÔºåÁøªËØëÊàê `MySQLÊï∞ÊçÆÁªìÊûú` ËøîÂõûÁªô `MySQL Client`„ÄÇ

ËøôÊ†∑‰∏ÄÁúãÔºåMyCAT ËøûÊé• MongoDB ÊòØ‰∏çÊòØÂ∞ëÁ•ûÂ•á‰∏ÄÁÇπÂàó„ÄÇ

![](2ffed32.png)

JavaÊï∞ÊçÆÂ∫ìËøûÊé•ÔºåÔºàJava Database ConnectivityÔºåÁÆÄÁß∞JDBCÔºâÊòØJavaËØ≠Ë®Ä‰∏≠Áî®Êù•ËßÑËåÉÂÆ¢Êà∑Á´ØÁ®ãÂ∫èÂ¶Ç‰ΩïÊù•ËÆøÈóÆÊï∞ÊçÆÂ∫ìÁöÑÂ∫îÁî®Á®ãÂ∫èÊé•Âè£ÔºåÊèê‰æõ‰∫ÜËØ∏Â¶ÇÊü•ËØ¢ÂíåÊõ¥Êñ∞Êï∞ÊçÆÂ∫ì‰∏≠Êï∞ÊçÆÁöÑÊñπÊ≥ï„ÄÇJDBC‰πüÊòØSun MicrosystemsÁöÑÂïÜÊ†á„ÄÇJDBCÊòØÈù¢ÂêëÂÖ≥Á≥ªÂûãÊï∞ÊçÆÂ∫ìÁöÑ„ÄÇ

MyCAT ‰ΩøÁî® JDBC ËßÑËåÉÔºåÊäΩË±°‰∫ÜÂØπ MongoDB ÁöÑËÆøÈóÆ„ÄÇÈÄöËøáËøôÊ†∑ÁöÑÊñπÂºèÔºåMyCAT ‰πüÊäΩË±°‰∫Ü SequoiaDB ÁöÑËÆøÈóÆ„ÄÇÂèØËÉΩËøôÊ†∑ËØ¥Ê≥ïÊúâ‰∫õÊäΩË±°ÔºåÁúã‰∏™Á±ªÂõæÂéãÂéãÊÉä„ÄÇ

![](f9ed01a.png)

ÊòØ‰∏çÊòØÁÜüÊÇâÁöÑÂë≥ÈÅì„ÄÇ**‰∏çÂæó‰∏çËØ¥ JDBC ËßÑËåÉÁöÑÁ≤æÂ¶ô„ÄÇ**

# 3. Êü•ËØ¢Êìç‰Ωú

    SELECT id, name FROM user WHERE name > '' ORDER BY _id DESC;

![](a049745.png)

ÁúãÈ°∫Â∫èÂõæÂ∑≤ÁªèÂæàÊñπ‰æøÁöÑÁêÜËß£Êï¥‰ΩìÈÄªËæëÔºåÊàëÂ∞±‰∏çÂ§öÂ∫üËØùÂï¶„ÄÇÊàë‰ª¨Êù•ÁúãÂá†‰∏™Ê†∏ÂøÉÁöÑ‰ª£Á†ÅÈÄªËæë„ÄÇ

**1„ÄÅÊü•ËØ¢ MongoDB**

    // MongoSQLParser.java
    public MongoData query() throws MongoSQLException {
       if (!(statement instanceof SQLSelectStatement)) {
           //return null;
           throw new IllegalArgumentException("not a query sql statement");
       }
       MongoData mongo = new MongoData();
       DBCursor c = null;
       SQLSelectStatement selectStmt = (SQLSelectStatement) statement;
       SQLSelectQuery sqlSelectQuery = selectStmt.getSelect().getQuery();
       int icount = 0;
       if (sqlSelectQuery instanceof MySqlSelectQueryBlock) {
           MySqlSelectQueryBlock mysqlSelectQuery = (MySqlSelectQueryBlock) selectStmt.getSelect().getQuery();
    
           BasicDBObject fields = new BasicDBObject();
    
           // ÊòæÁ§∫ÔºàËøîÂõûÔºâÁöÑÂ≠óÊÆµ
           for (SQLSelectItem item : mysqlSelectQuery.getSelectList()) {
               //System.out.println(item.toString());
               if (!(item.getExpr() instanceof SQLAllColumnExpr)) {
                   if (item.getExpr() instanceof SQLAggregateExpr) {
                       SQLAggregateExpr expr = (SQLAggregateExpr) item.getExpr();
                       if (expr.getMethodName().equals("COUNT")) { // TODO ÂæÖËØªÔºöcountÔºà*Ôºâ
                           icount = 1;
                           mongo.setField(getExprFieldName(expr), Types.BIGINT);
                       }
                       fields.put(getExprFieldName(expr), 1);
                   } else {
                       fields.put(getFieldName(item), 1);
                   }
               }
    
           }
    
           // Ë°®Âêç
           SQLTableSource table = mysqlSelectQuery.getFrom();
           DBCollection coll = this._db.getCollection(table.toString());
           mongo.setTable(table.toString());
    
           // WHERE
           SQLExpr expr = mysqlSelectQuery.getWhere();
           DBObject query = parserWhere(expr);
    
           // GROUP BY
           SQLSelectGroupByClause groupby = mysqlSelectQuery.getGroupBy();
           BasicDBObject gbkey = new BasicDBObject();
           if (groupby != null) {
               for (SQLExpr gbexpr : groupby.getItems()) {
                   if (gbexpr instanceof SQLIdentifierExpr) {
                       String name = ((SQLIdentifierExpr) gbexpr).getName();
                       gbkey.put(name, Integer.valueOf(1));
                   }
               }
               icount = 2;
           }
    
           // SKIP / LIMIT
           int limitoff = 0;
           int limitnum = 0;
           if (mysqlSelectQuery.getLimit() != null) {
               limitoff = getSQLExprToInt(mysqlSelectQuery.getLimit().getOffset());
               limitnum = getSQLExprToInt(mysqlSelectQuery.getLimit().getRowCount());
           }
           if (icount == 1) { // COUNTÔºà*Ôºâ
               mongo.setCount(coll.count(query));
           } else if (icount == 2) { // MapReduce
               BasicDBObject initial = new BasicDBObject();
               initial.put("num", 0);
               String reduce = "function (obj, prev) { " + "  prev.num++}";
               mongo.setGrouyBy(coll.group(gbkey, query, initial, reduce));
           } else {
               if ((limitoff > 0) || (limitnum > 0)) {
                   c = coll.find(query, fields).skip(limitoff).limit(limitnum);
               } else {
                   c = coll.find(query, fields);
               }
    
               // order by
               SQLOrderBy orderby = mysqlSelectQuery.getOrderBy();
               if (orderby != null) {
                   BasicDBObject order = new BasicDBObject();
                   for (int i = 0; i < orderby.getItems().size(); i++) {
                       SQLSelectOrderByItem orderitem = orderby.getItems().get(i);
                       order.put(orderitem.getExpr().toString(), getSQLExprToAsc(orderitem.getType()));
                   }
                   c.sort(order);
                   // System.out.println(order);
               }
           }
           mongo.setCursor(c);
       }
       return mongo;
    }

**2„ÄÅÊü•ËØ¢Êù°‰ª∂**

    // MongoSQLParser.java
    private void parserWhere(SQLExpr aexpr, BasicDBObject o) {
       if (aexpr instanceof SQLBinaryOpExpr) {
           SQLBinaryOpExpr expr = (SQLBinaryOpExpr) aexpr;
           SQLExpr exprL = expr.getLeft();
           if (!(exprL instanceof SQLBinaryOpExpr)) {
               if (expr.getOperator().getName().equals("=")) {
                   o.put(exprL.toString(), getExpValue(expr.getRight()));
               } else {
                   String op = "";
                   if (expr.getOperator().getName().equals("<")) {
                       op = "$lt";
                   } else if (expr.getOperator().getName().equals("<=")) {
                       op = "$lte";
                   } else if (expr.getOperator().getName().equals(">")) {
                       op = "$gt";
                   } else if (expr.getOperator().getName().equals(">=")) {
                       op = "$gte";
                   } else if (expr.getOperator().getName().equals("!=")) {
                       op = "$ne";
                   } else if (expr.getOperator().getName().equals("<>")) {
                       op = "$ne";
                   }
                   parserDBObject(o, exprL.toString(), op, getExpValue(expr.getRight()));
               }
           } else {
               if (expr.getOperator().getName().equals("AND")) {
                   parserWhere(exprL, o);
                   parserWhere(expr.getRight(), o);
               } else if (expr.getOperator().getName().equals("OR")) {
                   orWhere(exprL, expr.getRight(), o);
               } else {
                   throw new RuntimeException("Can't identify the operation of  of where");
               }
           }
       }
    }
    
    private void orWhere(SQLExpr exprL, SQLExpr exprR, BasicDBObject ob) {
       BasicDBObject xo = new BasicDBObject();
       BasicDBObject yo = new BasicDBObject();
       parserWhere(exprL, xo);
       parserWhere(exprR, yo);
       ob.put("$or", new Object[]{xo, yo});
    }

**3„ÄÅËß£Êûê MongoDB Êï∞ÊçÆ**

    // MongoResultSet.java
    public MongoResultSet(MongoData mongo, String schema) throws SQLException {
       this._cursor = mongo.getCursor();
       this._schema = schema;
       this._table = mongo.getTable();
       this.isSum = mongo.getCount() > 0;
       this._sum = mongo.getCount();
       this.isGroupBy = mongo.getType();
    
       if (this.isGroupBy) {
           dblist = mongo.getGrouyBys();
           this.isSum = true;
       }
       if (this._cursor != null) {
           select = _cursor.getKeysWanted().keySet().toArray(new String[0]);
           // Ëß£Êûê fields
           if (this._cursor.hasNext()) {
               _cur = _cursor.next();
               if (_cur != null) {
                   if (select.length == 0) {
                       SetFields(_cur.keySet());
                   }
                   _row = 1;
               }
           }
           // ËÆæÁΩÆ fields Á±ªÂûã
           if (select.length == 0) {
               select = new String[]{"_id"};
               SetFieldType(true);
           } else {
               SetFieldType(false);
           }
       } else {
           SetFields(mongo.getFields().keySet());//new String[]{"COUNT(*)"};
           SetFieldType(mongo.getFields());
       }
    }

- ÂΩì‰ΩøÁî® `SELECT *` Êü•ËØ¢Â≠óÊÆµÊó∂Ôºåfields ‰ΩøÁî®Á¨¨‰∏ÄÊù°Êï∞ÊçÆËøîÂõûÁöÑ fields„ÄÇÂç≥‰ΩøÔºåÂêéÈù¢ÁöÑÊï∞ÊçÆÊúâÂÖ∂‰ªñ fieldsÔºå‰πü‰∏çËøîÂõû„ÄÇ

**4„ÄÅËøîÂõûÊï∞ÊçÆÁªô MySQL Client**

    // JDBCConnection.java
    private void ouputResultSet(ServerConnection sc, String sql)
           throws SQLException {
       ResultSet rs = null;
       Statement stmt = null;
    
       try {
           stmt = con.createStatement();
           rs = stmt.executeQuery(sql);
    
           // header
           List<FieldPacket> fieldPks = new LinkedList<>();
           ResultSetUtil.resultSetToFieldPacket(sc.getCharset(), fieldPks, rs, this.isSpark);
           int colunmCount = fieldPks.size();
           ByteBuffer byteBuf = sc.allocate();
           ResultSetHeaderPacket headerPkg = new ResultSetHeaderPacket();
           headerPkg.fieldCount = fieldPks.size();
           headerPkg.packetId = ++packetId;
           byteBuf = headerPkg.write(byteBuf, sc, true);
           byteBuf.flip();
           byte[] header = new byte[byteBuf.limit()];
           byteBuf.get(header);
           byteBuf.clear();
           List<byte[]> fields = new ArrayList<byte[]>(fieldPks.size());
           for (FieldPacket curField : fieldPks) {
               curField.packetId = ++packetId;
               byteBuf = curField.write(byteBuf, sc, false);
               byteBuf.flip();
               byte[] field = new byte[byteBuf.limit()];
               byteBuf.get(field);
               byteBuf.clear();
               fields.add(field);
           }
           // header eof
           EOFPacket eofPckg = new EOFPacket();
           eofPckg.packetId = ++packetId;
           byteBuf = eofPckg.write(byteBuf, sc, false);
           byteBuf.flip();
           byte[] eof = new byte[byteBuf.limit()];
           byteBuf.get(eof);
           byteBuf.clear();
           this.respHandler.fieldEofResponse(header, fields, eof, this);
    
           // row
           while (rs.next()) {
               RowDataPacket curRow = new RowDataPacket(colunmCount);
               for (int i = 0; i < colunmCount; i++) {
                   int j = i + 1;
                   if (MysqlDefs.isBianry((byte) fieldPks.get(i).type)) {
                       curRow.add(rs.getBytes(j));
                   } else if (fieldPks.get(i).type == MysqlDefs.FIELD_TYPE_DECIMAL ||
                           fieldPks.get(i).type == (MysqlDefs.FIELD_TYPE_NEW_DECIMAL - 256)) { // field type is unsigned byte
                       // ensure that do not use scientific notation format
                       BigDecimal val = rs.getBigDecimal(j);
                       curRow.add(StringUtil.encode(val != null ? val.toPlainString() : null, sc.getCharset()));
                   } else {
                       curRow.add(StringUtil.encode(rs.getString(j), sc.getCharset()));
                   }
               }
               curRow.packetId = ++packetId;
               byteBuf = curRow.write(byteBuf, sc, false);
               byteBuf.flip();
               byte[] row = new byte[byteBuf.limit()];
               byteBuf.get(row);
               byteBuf.clear();
               this.respHandler.rowResponse(row, this);
           }
           fieldPks.clear();
           // row eof
           eofPckg = new EOFPacket();
           eofPckg.packetId = ++packetId;
           byteBuf = eofPckg.write(byteBuf, sc, false);
           byteBuf.flip();
           eof = new byte[byteBuf.limit()];
           byteBuf.get(eof);
           sc.recycle(byteBuf);
           this.respHandler.rowEofResponse(eof, this);
       } finally {
           if (rs != null) {
               try {
                   rs.close();
               } catch (SQLException e) {
               }
           }
           if (stmt != null) {
               try {
                   stmt.close();
               } catch (SQLException e) {
               }
           }
       }
    }
    
    // MongoResultSet.java
    @Override
    public String getString(String columnLabel) throws SQLException {
       Object x = getObject(columnLabel);
       if (x == null) {
           return null;
       }
       return x.toString();
    }

- ÂΩìËøîÂõûÂ≠óÊÆµÂÄºÊòØ Object Êó∂ÔºåËøîÂõûËØ•ÂØπË±°.toString()„ÄÇ‰æãÂ¶ÇÔºö

    mysql> select * from user order by _id asc;
    +--------------------------+------+-------------------------------+
    | _id                      | name | profile                       |
    +--------------------------+------+-------------------------------+
    | 1                        | 123  | { "age" : 1 , "height" : 100} |

# 4. ÊèíÂÖ•Êìç‰Ωú

![](86b8f14.png)

    // MongoSQLParser.java
    public int executeUpdate() throws MongoSQLException {
       if (statement instanceof SQLInsertStatement) {
           return InsertData((SQLInsertStatement) statement);
       }
       if (statement instanceof SQLUpdateStatement) {
           return UpData((SQLUpdateStatement) statement);
       }
       if (statement instanceof SQLDropTableStatement) {
           return dropTable((SQLDropTableStatement) statement);
       }
       if (statement instanceof SQLDeleteStatement) {
           return DeleteDate((SQLDeleteStatement) statement);
       }
       if (statement instanceof SQLCreateTableStatement) {
           return 1;
       }
       return 1;
    }
    
    private int InsertData(SQLInsertStatement state) {
       if (state.getValues().getValues().size() == 0) {
           throw new RuntimeException("number of  columns error");
       }
       if (state.getValues().getValues().size() != state.getColumns().size()) {
           throw new RuntimeException("number of values and columns have to match");
       }
       SQLTableSource table = state.getTableSource();
       BasicDBObject o = new BasicDBObject();
       int i = 0;
       for (SQLExpr col : state.getColumns()) {
           o.put(getFieldName2(col), getExpValue(state.getValues().getValues().get(i)));
           i++;
       }
       DBCollection coll = this._db.getCollection(table.toString());
       coll.insert(o);
       return 1;
    }

# 5. ÂΩ©Ëõã
{% endraw %}