---
layout: post
title:  "åˆæ¢Webxä¹‹çº¦å®šèƒœäºé…ç½®"
title2:  "åˆæ¢Webxä¹‹çº¦å®šèƒœäºé…ç½®"
date:   2017-01-01 23:56:57  +0800
source:  "https://www.jfox.info/%e5%88%9d%e6%8e%a2webx%e4%b9%8b%e7%ba%a6%e5%ae%9a%e8%83%9c%e4%ba%8e%e9%85%8d%e7%bd%ae.html"
fileName:  "20170101317"
lang:  "zh_CN"
published: true
permalink: "2017/%e5%88%9d%e6%8e%a2webx%e4%b9%8b%e7%ba%a6%e5%ae%9a%e8%83%9c%e4%ba%8e%e9%85%8d%e7%bd%ae.html"
---
{% raw %}
åœ¨åˆ†æä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å¼ºè°ƒ `Webx` çš„ä¸€ä¸ªé‡è¦è®¾è®¡ç†å¿µâ€”â€”çº¦å®šèƒœäºé…ç½®ã€‚â€œçº¦å®šâ€å³è§„åˆ™ï¼Œè§„åˆ™æ˜¯é¢„å…ˆå®šä¹‰çš„ï¼Œå·¥ç¨‹å¸ˆåªéœ€è¦æŒ‰ç€è§„åˆ™æ¥åšäº‹ï¼Œå°±ä¸éœ€è¦é¢å¤–çš„â€œé…ç½®â€ã€‚å¯¹æ¯”å…¶å®ƒä¸€äº›æ¡†æ¶ï¼Œå¾€å¾€æ¯å¢åŠ ä¸€ä¸ªé¡µé¢ï¼Œéƒ½éœ€è¦åœ¨é…ç½®æ–‡ä»¶ä¸­å¢åŠ è‹¥å¹²è¡Œå†…å®¹ã€‚ 

 æ³¨æ„ï¼Œæœ¬ç¯‡æ–‡ç« ä»…ç”¨äºè§£ç­”ä¸Šæ–‡æå‡ºçš„ä¸¤ä¸ªç–‘é—®ï¼Œæ›´å¤š `Webx` çš„è®¾è®¡ç†å¿µåŠåŸç†æ€§çŸ¥è¯†è¯·å‚é˜… [å®˜æ–¹æ–‡æ¡£](https://www.jfox.info/go.php?url=http://openwebx.org/docs/) ã€‚ 

## execute()ä¸ºä»€ä¹ˆä¼šè¢«è°ƒç”¨ï¼Ÿ 

 æœ¬æ–‡ä»¥è§£æè¯·æ±‚ `http://localhost:8080/webx/simple/say_hi.do` ä¸ºä¾‹æ¥å›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼Œåœ¨ `SayHi` ç±»ä¸­ `execute()` å¤„æ·»åŠ æ–­ç‚¹ï¼Œå¯åŠ¨ `Tomcat` ï¼Œç¨‹åºæ‰§è¡Œè‡³æ–­ç‚¹å¤„ï¼ŒæŸ¥çœ‹æ­¤æ—¶å½“å‰çº¿ç¨‹çš„å‡½æ•°è°ƒç”¨æ ˆï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆæˆªå–äº†éƒ¨åˆ†ï¼‰ã€‚ 

![](1ca80c8.png)

 æƒ³è¦æ›´å¥½çš„ç†è§£è¯¥å‡½æ•°è°ƒç”¨æ ˆçš„ä¿¡æ¯ï¼Œéœ€è¦å…ˆä»ç†è®ºä¸Šå¯¹ `Webx` å¤„ç†ä¸€ä¸ª `Web` è¯·æ±‚æœ‰ä¸€ä¸ªè®¤çŸ¥ã€‚ 

-  é¦–å…ˆï¼Œå¢å¼º `request` ã€ `response` ã€ `session` çš„åŠŸèƒ½ï¼Œå¹¶æŠŠå®ƒä»¬æ‰“åŒ…æˆæ›´æ˜“ä½¿ç”¨çš„ `RequestContext` å¯¹è±¡ã€‚ 
-  å…¶æ¬¡ï¼Œå®ƒä¼šè°ƒç”¨ç›¸åº”å­åº”ç”¨çš„ `pipeline` ï¼Œç”¨å®ƒæ¥åšè¿›ä¸€æ­¥çš„å¤„ç†ã€‚ 

`pipeline` æ˜¯ `Webx` çš„ä¸€ç§æœºåˆ¶ï¼Œè¿™ç§æœºåˆ¶ç»™äºˆå¼€å‘è€…æå¤§çš„è‡ªç”±æ¥è‡ªå®šåˆ¶å¤„ç†è¯·æ±‚çš„æµç¨‹ã€‚ `pipeline` ç”±ä¸€ç³»åˆ—çš„ `valve` æ„æˆï¼Œä¸€ä¸ªè¯·æ±‚åœ¨è·å–å“åº”ï¼ˆ `Module` ï¼‰å‰éœ€ç»å†è¿™ä¸€ç³»åˆ— `valve` ã€‚ `Webx` å°† `URL` æ˜ å°„æˆ `target` ï¼Œç”±å¼€å‘è€…å®šåˆ¶ä¸åŒç±»å‹çš„ `target` æ‰€åŒ¹é…çš„ `pipeline` ã€‚ä¾‹å¦‚ï¼Œå½“å‰è¯·æ±‚çš„ `target` ä¸º `/simple/say_hi.do` ï¼Œä¸ä¹‹å¯¹åº”çš„ `pipeline` å¦‚ä¸‹æ‰€ç¤ºã€‚ 

    <when>
        <!-- æ‰§è¡Œä¸å¸¦æ¨¡æ¿çš„screenï¼Œæ— layoutã€‚ -->
        <pl-conditions:target-extension-conditionextension="do"/>
        <pl-valves:performAction/>
        <pl-valves:performScreen/>
    </when>
    

 ç»“åˆ `pipeline` ä¸å‡½æ•°è°ƒç”¨æ ˆï¼Œåœ¨æ‰§è¡Œ `execute()` ä¹‹å‰ï¼Œè¯·æ±‚ç»å†äº†ä¸€ç³»åˆ— `invoke()` ä¸ `invokeNext()` ã€‚é¦–å…ˆæ‰§è¡Œ `<pl-valves:performAction />` å¯¹åº” `PerformActionValve` ä¸­çš„ `invoke()` ä¸ `invokeNext()` ï¼Œç”±äºå½“å‰è¯·æ±‚å¹¶ä¸åŒ…å«è¡¨å•æäº¤ï¼Œæ‰€ä»¥ `PerformActionValve` ä¸åšä»»ä½•æ“ä½œã€‚æ¥ç€æ‰§è¡Œ `<pl-valves:performScreen />` å¯¹åº”çš„ `PerformScreenValve` ä¸­çš„ `invoke()` ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘ä»¬åˆ†æçš„é‡ç‚¹ï¼Œè¯¥ `invoke` æ–¹æ³•å¯¹åº”çš„æºç å¦‚ä¸‹æ‰€ç¤ºã€‚ 

    public void invoke(PipelineContext pipelineContext)throwsException{
        TurbineRunData rundata = TurbineUtil.getTurbineRunData(this.request);
        if(!rundata.isRedirected()) {
            this.setContentType(rundata);
            Object result = null;
    
            try {
                result = this.performScreenModule(rundata);
            } finally {
                this.setOutputValue(pipelineContext, result);
            }
        }
    
        pipelineContext.invokeNext();
    }
    

 è¿›å…¥ `performScreenModule` æ–¹æ³•ï¼Œå…¶æºç å¦‚ä¸‹æ‰€ç¤ºï¼ˆçœç•¥éƒ¨åˆ†æ— å…³ä»£ç ï¼‰ã€‚ 

    protectedObjectperformScreenModule(TurbineRunData rundata){
        PerformScreenValve.ModuleFinder finder = new PerformScreenValve.ModuleFinder(rundata.getTarget());
        rundata.setLayoutEnabled(true);
        try {
            Module e = finder.getScreenModule();
            if(e != null) {
                ScreenEventUtil.setEventName(rundata.getRequest(), finder.event);
                Object var4;
                try {
                    if(!(e instanceof ModuleReturningValue)) {
                        e.execute();
                        return null;
                    }
                    var4 = ((ModuleReturningValue)e).executeAndReturn();
                } finally {
                    ...
                }
                return var4;
            } 
            ...
        } 
        ...
    }
    

`performScreenModule` é¦–å…ˆæ ¹æ®å½“å‰ `target` è·å–å¯¹åº”çš„ `Module` ã€‚åœ¨ `Webx` ä¸­ï¼Œ `Module` æ‰¿æ‹…äº†ç”¨æˆ·æäº¤æ•°æ®çš„æ¥æ”¶ä¸å¤„ç†ã€è¯·æ±‚çš„æ§åˆ¶ä¸è½¬å‘ã€å¤„ç†ç»“æœçš„å±•ç¤ºç­‰é‡è¦åŠŸèƒ½ã€‚ `Webx` ç¼ºçœå®šä¹‰äº†ä¸‰ç§ç±»å‹çš„ `Module` ã€‚ 

- `action` ï¼šä¸»è¦ç”¨äºå¤„ç†ç”¨æˆ·æäº¤çš„æ•°æ®ï¼Œä»¥åŠè¯·æ±‚çš„æ§åˆ¶ä¸è½¬å‘ã€‚ 
- `screen` ï¼šä¸»è¦ç”¨äºå¤„ç†é¡µé¢çš„ä¸»ä½“å†…å®¹ã€‚ 
- `control` ï¼šä¸»è¦ç”¨äºå¤„ç†é¡µé¢çš„éƒ¨åˆ†å†…å®¹ï¼Œç‰¹åˆ«æ˜¯å¯é‡ç”¨çš„å†…å®¹ã€‚ 

 æˆ‘ä»¬æ¥ç€è¿›å…¥ `finder.getScreenModule()` ï¼Œæºç å¦‚ä¸‹ã€‚ 

    publicModulegetScreenModule()throwsModuleLoaderException{
        this.moduleName = PerformScreenValve.this.getModuleName(this.target);
        Module module = PerformScreenValve.this.moduleLoaderService.getModuleQuiet("screen", this.moduleName);
        if(module != null) {
            return module;
        } else {
            if(this.parseEvent()) {
                module = PerformScreenValve.this.moduleLoaderService.getModuleQuiet("screen", this.eventModuleName);
                if(module instanceof ModuleEvent) {
                    return module;
                }
            }
    
            return null;
        }
    }
    

 æ‰“æ–­ç‚¹ä¸€æ­¥ä¸€æ­¥æ·±å…¥ä¸‹å»ï¼Œè¿›å…¥ `getModuleQuiet()` ï¼Œæºç å¦‚ä¸‹ã€‚ 

    publicModulegetModuleQuiet(String moduleType, String moduleName)throwsModuleLoaderException{
        ModuleKey moduleKey = new ModuleKey(moduleType, moduleName);
        moduleType = moduleKey.getModuleType();
        moduleName = moduleKey.getModuleName();
        if(this.cacheEnabled.booleanValue()) {
            Module moduleObject = (Module)this.moduleCache.get(moduleKey);
            if(moduleObject != null) {
                return moduleObject;
            }
        }
    
        Object var10 = null;
        Module module = null;
        ModuleFactory[] arr$ = this.factories;
        int len$ = arr$.length;
    
        int i$;
        for(i$ = 0; i$ < len$; ++i$) {
            ModuleFactory adapter = arr$[i$];
            var10 = adapter.getModule(moduleType, moduleName);
            if(var10 != null) {
                break;
            }
        }
    
        if(var10 != null) {
            if(var10 instanceof Module) {
                module = (Module)var10;
            } else {
                ModuleAdapterFactory[] var11 = this.adapters;
                len$ = var11.length;
    
                for(i$ = 0; i$ < len$; ++i$) {
                    ModuleAdapterFactory var12 = var11[i$];
                    module = var12.adapt(moduleType, moduleName, var10);
                    if(module != null) {
                        break;
                    }
                }
            }
        }
    
        if(module == null && var10 != null) {
            throw new UnadaptableModuleException("Could not adapt object to module: type=" + moduleType + ", name=" + moduleName + ", class=" + var10.getClass());
        } else {
            if(this.cacheEnabled.booleanValue() && module != null) {
                this.moduleCache.put(moduleKey, module);
            }
    
            return module;
        }
    }
    

 åœ¨ `getModuleQuiet()` ä¸­ï¼Œé¦–å…ˆæ ¹æ® `moduleType` å’Œ `moduleName` åˆ›å»º `modulekey` ï¼Œ `Webx` ä¼šå¯¹ `Module` è¿›è¡Œç¼“å­˜ï¼Œå› æ­¤é¦–å…ˆæ ¹æ® `moduleKey` ä»ç¼“å­˜ä¸­è·å– `Module` ã€‚å¦‚æœç¼“å­˜ä¸­è¿˜ä¸å­˜åœ¨å½“å‰ `target` å¯¹åº”çš„ `Module` ï¼Œç»§ç»­æ·±å…¥ï¼Œè¿›å…¥ `DataBindingAdapterFactory` ç±»çš„ `adapt` æ–¹æ³•ï¼Œæºç å¦‚ä¸‹ã€‚ 

    publicModuleadapt(String type, String name, Object moduleObject){
        ModuleInfo moduleInfo = new ModuleInfo(type, name);
        Class moduleClass = moduleObject.getClass();
        Method executeMethod = this.getMethod(moduleClass, "execute");
        if(executeMethod != null) {
            FastClass fc = FastClass.create(moduleClass);
            FastMethod fm = fc.getMethod(executeMethod);
            boolean skippable = "action".equalsIgnoreCase(type);
            return new DataBindingAdapter(moduleObject, this.getMethodInvoker(fm, moduleInfo, skippable));
        } else {
            return null;
        }
    }
    

 åœ¨ `adapt` æ–¹æ³•ä¸­ï¼Œä¸€åˆ‡å¼€å§‹å˜å¾—æ¸…æ™°èµ·æ¥ï¼šé¦–å…ˆå°è¯•è·å– `moduleObject` çš„ `execute()` æ–¹æ³•ï¼Œè‹¥å­˜åœ¨ï¼Œé‚£ä¹ˆå½“å‰ `target` å¯¹åº”çš„Moduleçš„æœ€å…³é”®éƒ¨åˆ†ä¹Ÿå°±æ„å»ºå®Œæˆäº†ã€‚  è‡³æ­¤ï¼Œç¬¬ä¸€ä¸ªç–‘é—®â€œä¸ºä»€ä¹ˆ `execute()` ä¼šè¢«è°ƒç”¨â€å¾—åˆ°äº†è§£ç­”  ã€‚ 

 è·å–äº† `Module` ä¹‹åï¼Œ `executeAndReturn()` è°ƒç”¨ `execute()` ï¼Œå®Œæˆé¡µé¢ä¸»ä½“å†…å®¹çš„å¤„ç†ã€‚ `executeAndReturn()` æºç å¦‚ä¸‹ã€‚ 

    publicObjectexecuteAndReturn()throwsException{
        return this.executeMethod.invoke(this.moduleObject, this.log);
    }
    

## doChinese()ä¸ºä»€ä¹ˆä¼šè¢«è°ƒç”¨ï¼Ÿ 

 æ­¤æ—¶ `Web` è¯·æ±‚ `URL` ä¸º `http://localhost:8080/webx/multievent/say_hello_1/chinese.do` ï¼Œå› æ­¤ç›¸åº”çš„ `target` å³ä¸º `/multievent/say_hello_1/chinese.do` ã€‚ä¸ç¬¬ä¸€ä¸ªé—®é¢˜çš„è¯·æ±‚å¤„ç†æµç¨‹ç›¸åŒï¼Œ `Webx` é¦–å…ˆæ ¹æ®å½“å‰ `target` å»è·å– `Module` ï¼Œè‹¥æ— æ³•è·å–ï¼Œé‚£ä¹ˆè®¤ä¸ºå½“å‰ `target` æ˜¯ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼š `event` å’Œ `eventModuleName` ï¼Œè§£æ `target` çš„æºç å¦‚ä¸‹ã€‚ 

    private boolean parseEvent(){
        int slashIndex = this.target.lastIndexOf("/");
        int dotIndex = this.target.lastIndexOf(".");
        if(slashIndex > 0) {
            this.event = this.target.substring(slashIndex + 1, dotIndex > slashIndex?dotIndex:this.target.length());
            this.eventModuleName = PerformScreenValve.this.getModuleName(this.target.substring(0, slashIndex));
            return true;
        } else {
            return false;
        }
    }
    

 ç»§ç»­æ‰“æ–­ç‚¹æ·±å…¥æºç ï¼Œ `Webx` ä¼šå°† `eventModuleName` ä½œä¸º `moduleName` è·å– `Module` ã€‚åŒæ ·çš„ï¼Œé¦–å…ˆå°è¯•è·å– `execute()` ï¼Œå¦‚æœè·å–ä¸åˆ°ä¾¿è·å–æ‰€æœ‰çš„ `EventHandler` ï¼Œæºç å¦‚ä¸‹ã€‚ 

    privateMap<String, Method>getEventHandlers(Class<?> moduleClass){
        HashMap handlers = null;
        Method[] arr$ = moduleClass.getMethods();
        int len$ = arr$.length;
    
        for(int i$ = 0; i$ < len$; ++i$) {
            Method method = arr$[i$];
            if(this.checkMethod(method)) {
                String methodName = method.getName();
                if(methodName.length() > 2 && methodName.startsWith("do") && Character.isUpperCase(methodName.charAt(2))) {
                    String eventName = StringUtil.toCamelCase(methodName.substring(2));
                    if("perform".equals(eventName)) {
                        eventName = null;
                    }
    
                    if(handlers == null) {
                        handlers = CollectionUtil.createHashMap();
                    }
    
                    handlers.put(eventName, method);
                }
            }
        }
    
        return handlers;
    }
    

 è‡³æ­¤æˆ‘ä»¬ç†è§£ä¸ºä»€ä¹ˆ `doChinese()` ä¸ºä»€ä¹ˆä¼šè¢«è°ƒç”¨äº†ï¼šè·å–å½“å‰ `target` å¯¹åº”çš„ `screen` çš„ç±»çš„æ‰€æœ‰ä»¥ `do` å¼€å¤´çš„æ–¹æ³•ï¼Œæ„å»º `eventName` ä¸ `Method` çš„æ˜ å°„å…³ç³»ï¼Œå­˜å‚¨åœ¨ä¸€ä¸ª `Map` ä¸­ï¼Œæ³¨æ„æˆ‘ä»¬çš„ `target` å·²è¢«åˆ’åˆ†ä¸º `event` å’Œ `eventModuleName` ï¼Œåœ¨ `executeAndReturn()` ä¸­æ ¹æ® `event` ä» `Map` ä¸­è·å–ç›¸åº”çš„ `Method` å¹¶æ‰§è¡Œï¼Œæºç å¦‚ä¸‹ï¼ˆçœç•¥éƒ¨åˆ†æ— å…³ä»£ç ï¼‰ã€‚ 

    publicObjectexecuteAndReturn()throwsModuleEventException, ModuleEventNotFoundException{
        Object result = null;
        String event = this.getEventName(this.request);
        MethodInvoker handler = null;
        if(event != null) {
            handler = (MethodInvoker)this.handlers.get(event);
        }
    
        if(handler == null) {
            handler = (MethodInvoker)this.handlers.get((Object)null);
        }
    ...
        result = handler.invoke(this.moduleObject, this.log);
        ...
    }
    

#### æ‰€ä»¥ç¬¬äºŒä¸ªç–‘é—®ä¹Ÿå¾—åˆ°äº†è§£ç­” ğŸ˜›
{% endraw %}